# Keepalived Ingress VIP

This is a lightweight HA/IP failover solution based on the [Virtual Router Redundancy Protocol (VRRP) implementation of Keepalived](https://keepalived.readthedocs.io/en/latest/case_study_failover.html) and provides floating IP addresses (VIPs) for external access to public-facing services running on Kubernetes nodes, such as Ingress controllers or the Kubernetes API servers.

## More Information

See the [Github project page](https://github.com/janeczku/keepalived-ingress-vip/tree/master) for additional information.

## Configuration Reference

The following table lists the configurable parameters of this chart and their default values.

| Parameter                           | Description                                                      | Default                                             |
| ----------------------------------- | -----------------------------------------------------------------| --------------------------------------------------- |
| `keepalived.debug`                  | Enable verbose logging                                           | `false`                                             |
| `keepalived.authPassword`.          | Shared VRRP authentication key (1-8 chars)                       | _autogenerated_                                     |
| `keepalived.vrrpInterfaceName`      | The host network interface name to use for VRRP traffic.         | `eth0`                                              |
| `keepalived.vipInterfaceName`       | The host network interface name to attach the VIP to.            | `eth0`                                              |
| `keepalived.vipAddressCidr`         | The Virtual IP address to use (in CIDR notation, e.g. `192.168.11.2/24`) | ``                                          |
| `keepalived.virtualRouterId`        | A unique numeric Keepalived Router ID.                           | `10`                                                |
| `keepalived.vrrpNoPreempt`          | Enable the Keepalived "nopreempt" option                         | `false`                                             |
| `keepalived.checkServiceUrl`        | URL checked to determine availability of the service endpoint provided on the local node (expects HTTP status code 200) | `http://127.0.0.1:10254/healthz` (NGINX Ingress Controller) |
| `keepalived.checkServiceInterval`   | Interval for the service health check in seconds                 | `2`                                                 |
| `keepalived.checkServiceFailAfter`  | Number of failed service checks to allow before marking this Keepalived instance failed | `2`                          |
| `keepalived.checkKubelet`           | Remove VIP from Keepalived instance running on node with unhealthy Kubelet | `true`                                    |
| `keepalived.checkKubeletInterval`   | Interval for Kubelet health checks in seconds                    | `5`                                                 |
| `keepalived.checkKubeletFailAfter`  | Number of failed Kubelet health checks before marking this Keepalived instance failed | `5`                            |
| `keepalived.checkKubeletUrl`        | The URL checked to determine health of the local node Kubelet | `http://127.0.0.1:10248/healthz`                       |
| `keepalived.checkKubeApi`           | Reduce priority of a Keepalived instance running on a node that fails to communicate with the K8s API server | `true`  |
| `keepalived.checkKubeApiInterval`   | Interval for K8s API health checks in seconds                    | `5`                                                 |
| `keepalived.checkKubeApiFailAfter`  | Number of failed K8s API health checks before reducing priority of the keepalived instance (VIP may then be moved to a higher priority instance) | `5` |
| `kind`                              | The deployment resource to create for the Keepalived pods (one of 'Deployment' or 'Daemonset') | `Deployment`          |
| `image.repository`                  | Image repository to pull from                                    | `janeczku/keepalived-ingress-vip`                   |
| `image.tag`                         | Image tag to pull                                                | `v0.1.6`                                            |
| `image.pullPolicy`                  | Image pull policy                                                | `IfNotPresent`                                      |
| `rbac.create`                       | Whether to create the required RBAC resources                    | `true`                                              |
| `rbac.pspEnabled`                   | Whether to create the required PodSecurityPolicy                 | `false`                                             |
| `serviceAccount.name`               | Use an existing service account instead of creating a new one.   | ``                                                  |
| `pod.replicas`                      | The number of Keepalived instances to run in the cluster         | `2`                                                 |
| `pod.priorityClassName`             | The priority class to assign the pods to                         | `system-cluster-critical`                           |
| `pod.extraEnv`                      | Additional pod environment variables                             | `[]`                                                |
| `pod.resources.requests.cpu`        | CPU resource requests                                            | 80m                                                 |
| `pod.resources.limits.cpu`          | CPU resource limits                                              |                                                     |
| `pod.resources.requests.memory`     | Memory resource requests                                         | 6Mi                                                 |
| `pod.resources.limits.memory`       | Memory resource limits                                           | 12Mi                                                |
| `pod.nodeSelector`                  | Node selector                                                    | `{}`                                                |
| `pod.tolerations`                   | Custom pod taint tolerations                                     | see below for the default                           |
| `pod.tolerateMasterTaints`          | Configure taint tolerations that allows pods to run on master nodes | `false`                                          |
| `pod.affinity`                      | Additional pod affinity configuration                            | `{}`                                                |
| `pod.imagePullSecrets`              | Array of image Pull Secrets                                      | `[]`                                                |

Specify each parameter using the `--set key=value[,key=value]` argument to `helm install`.

#### Default Pod Taint Tolerations

By default the following tolerations are set by the Helm chart. You may use the `pod.tolerations` variable to override the default.

```
  tolerations:
  # If the the node becomes tainted as unreachable or not-ready one would typically want
  # the Keepalived instance to be migrated to healthy node without much delay.
  # Setting the tolerationSeconds value too low might cause the VIP to be evicted during a
  # scheduled upgrade of the Kubelet (which might be the desired behaviour in most cases anyways).
  - key: "node.kubernetes.io/unreachable"
    operator: "Exists"
    effect: "NoExecute"
    tolerationSeconds: 15
  - key: "node.kubernetes.io/not-ready"
    operator: "Exists"
    effect: "NoExecute"
    tolerationSeconds: 15
```